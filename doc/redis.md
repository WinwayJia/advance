
15、redis持久化

| 方式                                           | 命令                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 解释                                                                                                                                                          | 优点                                                                                                                                                                                                                                                                                                                                                                                                                    | 缺点                                                                                                                                                      |
| ---------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| RDB持久化（快照）                              | **save**: save命令会阻塞Redis服务器进程，直到RDB文件创建完毕为止，在Redis服务器阻塞期间，服务器不能处理任何命令请求<br>** bgsave**: 1. 服务器进程pid为1349派生出一个pid为1357的子进程，<br> 2. 子进程将数据写入到一个临时 RDB文件中<br> 3. 当子进程完成对新 RDB 文件的写入时，Redis 用新 RDB 文件替换原来的 RDB 文件，并删除旧的 RDB 文件。<br>**自动保存**: save 900 1    # 900 秒内有至少有 1 个键被改动<br> save 300 10   # 300 秒内有至少有 10 个键被改动<br> save 60 10000 # 60 秒内有至少有 1000 个键被改动 | RDB持久化是指在客户端输入save、bgsave或者达到配置文件自动保存快照条件时，将Redis 在内存中的数据生成快照保存在名字为 dump.rdb（文件名可修改）的二进制文件中。  | 1. RDB是一个非常紧凑（有压缩）的文件,它保存了某个时间点的数据,非常适用于数据的备份。<br> 2. RDB作为一个非常紧凑（有压缩）的文件，可以很方便传送到另一个远端数据中心 ，非常适用于灾难恢复.<br> 3. RDB在保存RDB文件时父进程唯一需要做的就是fork出一个子进程,接下来的工作全部由子进程来做，父进程不需要再做其他IO操作，所以RDB持久化方式可以最大化redis的性能.<br> 4. 与AOF相比,在恢复大的数据集的时候，RDB方式会更快一些. | 1. Redis意外宕机 时，会丢失部分数据<br>2. 当Redis数据量比较大时，fork的过程是非常耗时的，fork子进程时是会阻塞的，在这期间Redis 是不能响应客户端的请求的。 |
| AOF持久化（只追加操作的文件 Append-only file） |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态，也就是每当 Redis 执行一个改变数据集的命令时（比如 SET）， 这个命令就会被追加到 AOF 文件的末尾。 | 1. 使用AOF会让你的Redis更加持久化<br>2. AOF文件是一个只进行追加的日志文件，不需要在写入时读取文件。<br>3. Redis 可以在 AOF 文件体积变得过大时，自动地在后台对 AOF 进行重写 。<br>4. AOF文件可读性高，分析容易                                                                                                                                                                                                           |


##### 过期策略

redis会将设置了过期时间的key放到一个单独的字典(expires)，以后会有两种方式删除过期的key，`1. 集中处理:  定时遍历这个字典 2. 分散处理（惰性处理）: 访问key的时候，对key过期时间进行检查，如果过期了就立即删除。`

```c
/* Redis database representation. There are multiple databases identified
 * by integers from 0 (the default database) up to the max configured
 * database. The database number is the 'id' field in the structure. */
typedef struct redisDb {
    dict *dict;                 /* The keyspace for this DB */
    dict *expires;              /* Timeout of keys with a timeout set */
    dict *blocking_keys;        /* Keys with clients waiting for data (BLPOP)*/
    dict *ready_keys;           /* Blocked keys that received a PUSH */
    dict *watched_keys;         /* WATCHED keys for MULTI/EXEC CAS */
    int id;                     /* Database ID */
    long long avg_ttl;          /* Average TTL, just for stats */
} redisDb;
```

- 定时处理
- 惰性处理


参考资料：

[Redis缓存穿透、缓存雪崩、redis并发问题分析](https://juejin.im/post/5b961172f265da0ab7198f4d)